
    <!-- Cold Lava Custom Chat Widget -->
    <div class="cold-lava-widget">
        <button class="widget-button" id="coldLavaWidgetBtn" aria-label="Chat with Sophie">
            <img src="coldlava-icon.png" alt="Cold Lava AI" class="widget-logo">
            <div class="widget-tooltip">
                <p class="widget-tooltip-title">Chat to Sophie</p>
                <p class="widget-tooltip-subtitle">AI Assistant</p>
            </div>
        </button>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="widget-modal">
        <div class="widget-modal-content">
            <div class="chat-header">
                <div class="chat-header-info">
                    <img src="coldlava-icon.png" alt="Sophie" class="chat-avatar">
                    <div>
                        <h3>Sophie</h3>
                        <p>AI Assistant</p>
                    </div>
                </div>
                <button class="widget-modal-close" id="closeChat" aria-label="Close chat">&times;</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="chat-message bot-message">
                    <div class="message-content">
                        ðŸ‘‹ Hi! I'm Sophie, Cold Lava's AI assistant. How can I help you today?
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." autocomplete="off" />
                <button id="sendMessage" class="chat-send-btn" aria-label="Send message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            <div class="widget-footer">
                Powered by <strong>Cold Lava AI</strong>
            </div>
        </div>
    </div>

    <!-- Chat Widget Script -->
    <script>
        // Chat Widget State
        let retellChatId = null;
        let isWaitingForResponse = false;
        const AGENT_ID = 'agent_81da82d9b3ff61a0d0918ae0f2';

        // Open chat modal
        document.getElementById('coldLavaWidgetBtn').addEventListener('click', function() {
            const modal = document.getElementById('chatModal');
            modal.classList.add('active');
            setTimeout(function() {
                document.getElementById('chatInput').focus();
            }, 100);

            // Track in Facebook Pixel
            if (typeof fbq !== 'undefined') {
                fbq('track', 'ViewContent', {content_name: 'Chat Widget Opened'});
            }
        });

        // Close chat modal
        function closeModal() {
            const modal = document.getElementById('chatModal');
            modal.classList.remove('active');
        }

        document.getElementById('closeChat').addEventListener('click', closeModal);

        // Close on outside click
        document.getElementById('chatModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeModal();
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('chatModal');
                if (modal.classList.contains('active')) {
                    closeModal();
                }
            }
        });

        // Send message on Enter key
        document.getElementById('chatInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !isWaitingForResponse) {
                sendMessage();
            }
        });

        // Send message on button click
        document.getElementById('sendMessage').addEventListener('click', function() {
            if (!isWaitingForResponse) {
                sendMessage();
            }
        });

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';
            isWaitingForResponse = true;

            // Show typing indicator
            showTypingIndicator();

            try {
                // If first message, create chat session
                if (!retellChatId) {
                    const createResponse = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'create',
                            agent_id: AGENT_ID
                        })
                    });

                    if (!createResponse.ok) {
                        throw new Error('Failed to create chat session: ' + createResponse.status);
                    }

                    const createData = await createResponse.json();
                    retellChatId = createData.chat_id;

                    // Track first message in Facebook Pixel
                    if (typeof fbq !== 'undefined') {
                        fbq('track', 'Contact', {content_name: 'First Chat Message Sent'});
                    }
                }

                // Send message to chat
                const messageResponse = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'message',
                        chat_id: retellChatId,
                        content: message
                    })
                });

                if (!messageResponse.ok) {
                    throw new Error('Failed to send message: ' + messageResponse.status);
                }

                const messageData = await messageResponse.json();

                // Remove typing indicator
                removeTypingIndicator();

                // Add bot response to chat
                if (messageData.response && messageData.response.length > 0) {
                    // Get the last message from the agent
                    const lastMessage = messageData.response[messageData.response.length - 1];
                    if (lastMessage.role === 'assistant') {
                        addMessageToChat(lastMessage.content, 'bot');
                    }
                } else {
                    throw new Error('No response from assistant');
                }

            } catch (error) {
                console.error('Chat error:', error);
                removeTypingIndicator();
                addMessageToChat(
                    "Sorry, I'm having trouble connecting right now. Please try again or email us at oliver@otdm.net",
                    'bot'
                );
            } finally {
                isWaitingForResponse = false;
            }
        }

        function addMessageToChat(message, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message ' + (sender === 'user' ? 'user-message' : 'bot-message');

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message;

            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message bot-message typing-indicator';
            typingDiv.id = 'typingIndicator';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';

            typingDiv.appendChild(contentDiv);
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
    </script>

</body>
</html>
